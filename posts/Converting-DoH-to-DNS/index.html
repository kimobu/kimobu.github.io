<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Converting DoH to DNS" /><meta property="og:locale" content="en_US" /><meta name="description" content="In a previous post I wrote about investigations that I performed on DNS over HTTPS (DoH). That research was performed as part of Cyber Security Research. During Security Tool Development, I expanded on that research by implementing a Python script which creates DNS wire format packets from a DoH packet capture. This post describes how that script was made and how it works." /><meta property="og:description" content="In a previous post I wrote about investigations that I performed on DNS over HTTPS (DoH). That research was performed as part of Cyber Security Research. During Security Tool Development, I expanded on that research by implementing a Python script which creates DNS wire format packets from a DoH packet capture. This post describes how that script was made and how it works." /><link rel="canonical" href="https://kimobu.github.io/posts/Converting-DoH-to-DNS/" /><meta property="og:url" content="https://kimobu.github.io/posts/Converting-DoH-to-DNS/" /><meta property="og:site_name" content="kimobu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-06T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Converting DoH to DNS" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-07T09:30:23-04:00","datePublished":"2021-01-06T00:00:00-05:00","description":"In a previous post I wrote about investigations that I performed on DNS over HTTPS (DoH). That research was performed as part of Cyber Security Research. During Security Tool Development, I expanded on that research by implementing a Python script which creates DNS wire format packets from a DoH packet capture. This post describes how that script was made and how it works.","headline":"Converting DoH to DNS","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimobu.github.io/posts/Converting-DoH-to-DNS/"},"url":"https://kimobu.github.io/posts/Converting-DoH-to-DNS/"}</script><title>Converting DoH to DNS | kimobu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="kimobu"><meta name="application-name" content="kimobu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">kimobu</a></div><div class="site-subtitle font-italic">Docendo discimus</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/kimobu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kimo','kimobu.space'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://infosec.exchange/@kimobu" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Converting DoH to DNS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Converting DoH to DNS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Kimo B </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jan 6, 2021, 12:00 AM -0500" prep="on" > Jan 6, 2021 <i class="unloaded">2021-01-06T00:00:00-05:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 7, 2021, 9:30 AM -0400" prefix="Updated " > Jun 7, 2021 <i class="unloaded">2021-06-07T09:30:23-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1256 words">6 min</span></div></div><div class="post-content"><p>In a <a href="/posts/Investigating-DoH/">previous post</a> I wrote about investigations that I performed on DNS over HTTPS (DoH). That research was performed as part of <a href="https://catalog.dsu.edu/preview_course_nopop.php?catoid=32&amp;coid=20604">Cyber Security Research</a>. During <a href="https://catalog.dsu.edu/preview_course_nopop.php?catoid=32&amp;coid=20607">Security Tool Development</a>, I expanded on that research by implementing a Python script which creates DNS wire format packets from a DoH packet capture. This post describes how that script was made and how it works.</p><h1 id="updates-to-gen_dohpy">Updates to gen_doh.py</h1><p>In addition to the use of <code class="language-plaintext highlighter-rouge">sslkeylog</code> which was discussed in the previous post, I needed to update the <code class="language-plaintext highlighter-rouge">client_protocol.py</code> file. Line 45 of that file contains:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">sslctx</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">create_custom_ssl_context</span><span class="p">(</span>
            <span class="n">insecure</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">insecure</span><span class="p">,</span>
            <span class="n">cafile</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">cafile</span>
        <span class="p">)</span>
</pre></table></code></div></div><p>Due to the use of self-signed certificates, <code class="language-plaintext highlighter-rouge">insecure</code> needs to be set to True. I could not find a code path which allowed me to do that, and therefore had to modify line 46 to explicitly do so.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">sslctx</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">create_custom_ssl_context</span><span class="p">(</span>
            <span class="n">insecure</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">cafile</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">cafile</span>
        <span class="p">)</span>
</pre></table></code></div></div><p>Once these changes are made, <code class="language-plaintext highlighter-rouge">gen_doh.py</code> can be used to generate the test data.</p><h1 id="doh2dnspy">doh2dns.py</h1><p>Rommel once said “no plan survives contact with the enemy” and that is true in cyber security as well.</p><h2 id="initial-design-goals">Initial design goals</h2><p>My initial plan for extracting the information from the captured packets was to use the <code class="language-plaintext highlighter-rouge">tshark</code> command line utility to read the packets and use its <code class="language-plaintext highlighter-rouge">ssl.keylog_file</code> to decrypt those packets as I had previously done during CTF competitions. Once the capture file was read and decrypted, I would save the decrypted contents to a new .pcap. I could then process those packets, looking for DoH queries. However, I discovered that <code class="language-plaintext highlighter-rouge">tshark</code> decrypts packets for display, but does not actually buffer a decrypted packet which can be written to disk.</p><p>Once that was discovered, my new plan was to call tshark from a Python script and then parse the output of the command, using a regular expression to search for “GET.*dns=(.*)\b”. This approach proved promising, as I was able to detect the queries. Further text processing was needed to extract the specific information that I wanted. This approach can be found in a <a href="https://github.com/kimobu/doh-investigation/blob/a853cbc5c0f57bc8b56bc313b0b020afce27f4c8/doh2dns.py">previous commit</a>.</p><h2 id="final-design">Final design</h2><p>Thankfully, this class was collaborative in nature and a <a href="https://github.com/daddycocoaman">fellow student</a> suggested that I look into the <a href="https://github.com/KimiNewt/pyshark/">pyshark</a> package. Pyshark is a Python wrapper for tshark and allows for decrypted packets to be buffered in memory. With Pyshark, I could perform the programatic packet interactions that I wanted. With this package, the new workflow became:</p><ol><li>Read a Pcap<li>Correlate packet streams<li>Find DoH answers<li>Recreate DNS packets with Scapy<li>Retransmit DNS packets</ol><h3 id="reading-the-pcap-and-correlating-streams">Reading the Pcap and Correlating Streams</h3><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_streams</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Retrieving streams</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">pyshark</span><span class="p">.</span><span class="nc">FileCapture</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">pcap</span><span class="p">,</span>
                              <span class="n">override_prefs</span><span class="o">=</span><span class="p">{</span>
                                  <span class="sh">'</span><span class="s">tls.keylog_file</span><span class="sh">'</span><span class="p">:</span> <span class="n">args</span><span class="p">.</span><span class="n">sslkeylogfile</span>
                              <span class="p">})</span>
    <span class="n">cap</span><span class="p">.</span><span class="nf">load_packets</span><span class="p">()</span>
    <span class="n">streams</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="sh">"</span><span class="s">{l_bar}{bar}</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">packet</span><span class="p">.</span><span class="nf">__contains__</span><span class="p">(</span><span class="sh">'</span><span class="s">http2</span><span class="sh">'</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="n">streamid</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">:</span>
                <span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="n">streamid</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="n">streamid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="n">streamid</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] Identified </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">streams</span><span class="p">)</span><span class="si">}</span><span class="s"> different streams</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">streams</span>
</pre></table></code></div></div><p>In this first code block, the script reads the Pcap and correlates the streams. The Pcap is ready by using pyshark’s FileCapture() method. The first argument is the Pcap file to read. I also supply a second argument, <code class="language-plaintext highlighter-rouge">override_prefs</code>, which sets additional options to control how the method functions by passing a dictionary of options. In this case, ‘tls.keylog_file’ is used to specify the keylog file to decrypt the packets. Once the FileCapture object is created, its <code class="language-plaintext highlighter-rouge">load_packets()</code> method is used to read the packets from disk.</p><p>Next, <code class="language-plaintext highlighter-rouge">tqdm()</code> is used to display a progress bar for the processing of packets. The script iterates each packet and uses the <code class="language-plaintext highlighter-rouge">__contains__()</code> method to look for the HTTP2 protocol, which is the protocol used by DoH. If the packet uses the HTTP2 protocol, the packet is appended to a list of packets sharing the same streamid.</p><h3 id="finding-doh-answers">Finding DoH answers</h3><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">process_streams</span><span class="p">(</span><span class="n">streams</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ ] Finding DNS answers...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">dns_answers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">streamid</span><span class="p">,</span> <span class="n">packets</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">streams</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">bar_format</span><span class="o">=</span><span class="sh">"</span><span class="s">{l_bar}{bar}</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="sh">"</span><span class="s">{l_bar}{bar}</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">packet</span><span class="p">.</span><span class="nf">__contains__</span><span class="p">(</span><span class="sh">'</span><span class="s">http2</span><span class="sh">'</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_a</span><span class="sh">'</span><span class="p">)</span>\
                        <span class="ow">or</span> <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_aaaa</span><span class="sh">'</span><span class="p">)</span>\
                        <span class="ow">or</span> <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns.count.answers</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">:</span>
                    <span class="c1"># An answer was found.
</span>                    <span class="c1"># We can reconstruct a DNS packet using this information.
</span>                    <span class="n">packetdata</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># Client and Server fields are reversed
</span>                    <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">client</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span>
                    <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span>
                    <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">query</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_qry_name</span><span class="sh">'</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_a</span><span class="sh">'</span><span class="p">):</span>
                        <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_a</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">NXDOMAIN</span><span class="sh">"</span>
                        <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">packet</span><span class="p">.</span><span class="n">http2</span><span class="p">.</span><span class="nf">get_field</span><span class="p">(</span><span class="sh">'</span><span class="s">dns_aaaa</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">NXDOMAIN</span><span class="sh">"</span>
                        <span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">AAAA</span><span class="sh">'</span>
                    <span class="n">dns_answers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">packetdata</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] Found </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">dns_answers</span><span class="p">)</span><span class="si">}</span><span class="s"> DNS answers</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dns_answers</span>
</pre></table></code></div></div><p>The next step is to find DoH answers. The script accomplishes this by iterating each stream and then each packet. In each HTTP2 packet, it looks for one of the following fields: ‘dns_a’ for A records, ‘dns_aaaa’ for AAAA records, and ‘dns.count.answers’ for NX records.</p><p>If an answer is found, the script extracts useful information from the packet and creates a new object with that data. The ‘client’ is the computer which initiated the DNS query and is retrieved from the packet’s destination IP address (since this packet is an answer, the destination is the client). The ‘server’ is the packet’s source IP address. The ‘query’ is retrieved from the HTTP2 field ‘dns_qry_name’ and indicates the hostname that was queried, e.g. www.example.com. The ‘type’ is set appropriately based on IPv4 or IPv6 answers from the packet. Finally, the ‘answer’ is either the answer from the DoH server or NXDOMAIN is ‘dns.count.answers’ was set to 0.</p><h3 id="recreate-dns-packets-with-scapy-and-retransmit-the-query">Recreate DNS Packets with Scapy and Retransmit the Query</h3><p><a href="https://scapy.net">Scapy</a> is a Python package which allows you to craft custom packets in Python. There are several uses for Scapy in the cyber security space. For example, in another class I built a Python script with Scapy to act as a <a href="https://github.com/kimobu/python-nat">Network Address Translation</a> device by sniffing packets on one interface, modifying the packets, and then transmitting them out another interface. That work served as inspiration for this project.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">craft_query</span><span class="p">(</span><span class="n">packetdata</span><span class="p">):</span>
    <span class="n">dns_query</span> <span class="o">=</span> <span class="nc">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">server</span><span class="sh">'</span><span class="p">],</span>
                   <span class="n">src</span><span class="o">=</span><span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">client</span><span class="sh">'</span><span class="p">])</span>\
                <span class="o">/</span><span class="nc">UDP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="nc">RandShort</span><span class="p">(),</span>
                     <span class="n">dport</span><span class="o">=</span><span class="mi">53</span><span class="p">)</span>\
                <span class="o">/</span><span class="nc">DNS</span><span class="p">(</span><span class="n">rd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">qd</span><span class="o">=</span><span class="nc">DNSQR</span><span class="p">(</span><span class="n">qname</span><span class="o">=</span><span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">query</span><span class="sh">'</span><span class="p">],</span>
                              <span class="n">qtype</span><span class="o">=</span><span class="n">packetdata</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">dns_query</span>


<span class="k">def</span> <span class="nf">replay_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="nf">send</span><span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="nf">getlayer</span><span class="p">(</span><span class="n">IP</span><span class="p">),</span> <span class="n">iface</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">replay_interface</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><p>In <code class="language-plaintext highlighter-rouge">craft_query()</code> we pass the packet data extracted from the previous step and create a new DNS packet. The syntax to do this in Scapy is to call the IP() constructor and pass in the source and destination addresses. Then, call the UDP() constructor. The source port can be set to RandShort(), which will pick a random number from 0-65535. Using RandShort() was efficient but not necessarily effective - a better solution would have been to choose a number in the host operating system’s ephemeral port range. The destination port is set to 53, as that is what DNS typically uses. Lastly, call the DNS() constructor, setting recursive desired to 1 and the query and type as appropriate.</p><p>With a new packet in memory, the last action is to transmit the packet. Scapy’s <code class="language-plaintext highlighter-rouge">send()</code> function is used. The first option is the packet, starting at the IP layer and allowing the operating system to handle layers below that. The second option defines the interface on which to transmit. The last option is verbosity. In this script, I do not display information about transmitted packets.</p><h1 id="conclusion">Conclusion</h1><p>At this point, packets would be transmitted out of another interface. My thought here is that the specified interface would feed onto a LAN monitored by a Network Monitoring System where any number of algorithms could be used to detect malicious activity. Future work in this project could include decrypting TLS 1.3 as well as real-time decryption of packets.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/research/'>research</a>, <a href='/categories/networking/'>networking</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/research/" class="post-tag no-text-decoration" >research</a> <a href="/tags/school/" class="post-tag no-text-decoration" >school</a> <a href="/tags/dns/" class="post-tag no-text-decoration" >dns</a> <a href="/tags/doh/" class="post-tag no-text-decoration" >doh</a> <a href="/tags/networking/" class="post-tag no-text-decoration" >networking</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Converting DoH to DNS - kimobu&url=https://kimobu.github.io/posts/Converting-DoH-to-DNS/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Converting DoH to DNS - kimobu&u=https://kimobu.github.io/posts/Converting-DoH-to-DNS/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Converting DoH to DNS - kimobu&url=https://kimobu.github.io/posts/Converting-DoH-to-DNS/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SecurityOnion-GPT/">SecurityOnion GPT</a><li><a href="/posts/Adding-Phishing-to-the-Homelab/">Putting phishing data into Security Onion</a><li><a href="/posts/Books-of-2022/">Recap of the books I read in 2022</a><li><a href="/posts/Books-of-2021/">Recap of the books I read in 2021</a><li><a href="/posts/Books-of-2017/">Recap of the books I read in 2017</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Investigating-DoH/"><div class="card-body"> <span class="timeago small" > Dec 31, 2019 <i class="unloaded">2019-12-31T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Investigating DoH</h3><div class="text-muted small"><p> DNS Security As a plain-text protocol, DNS lacks Confidentiality, Integrity, and Availability (CIA) protections. An attacker who can observe DNS activity can see where the DNS request originated fr...</p></div></div></a></div><div class="card"> <a href="/posts/log4j-JDNI-Exploitation/"><div class="card-body"> <span class="timeago small" > Dec 10, 2021 <i class="unloaded">2021-12-10T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>log4j JNDI Exploitation</h3><div class="text-muted small"><p> Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URL...</p></div></div></a></div><div class="card"> <a href="/posts/Reflecting-on-a-PhD/"><div class="card-body"> <span class="timeago small" > May 13, 2022 <i class="unloaded">2022-05-13T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reflecting on Completing a PhD</h3><div class="text-muted small"><p> In March of this year, I successfully defended my dissertation An Application of Machine Learning to Packed Mach-O Detection. After four years, I completed a PhD in Cyber Operations from Dakota Sta...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Books-of-2020/" class="btn btn-outline-primary" prompt="Older"><p>Recap of the books I read in 2020</p></a> <a href="/posts/Hacking-a-Computer-Remotely-through-a-Phone/" class="btn btn-outline-primary" prompt="Newer"><p>Hacking a Computer Remotely through a Phone</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/kimobu">Kimo B</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimobu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
