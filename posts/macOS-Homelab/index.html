<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Adding macOS to my security homelab" /><meta property="og:locale" content="en_US" /><meta name="description" content="This post has notes on how I added a macOS machine to my security homelab." /><meta property="og:description" content="This post has notes on how I added a macOS machine to my security homelab." /><link rel="canonical" href="https://kimobu.github.io/posts/macOS-Homelab/" /><meta property="og:url" content="https://kimobu.github.io/posts/macOS-Homelab/" /><meta property="og:site_name" content="kimobu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-10T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Adding macOS to my security homelab" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-10T00:00:00-04:00","datePublished":"2023-05-10T00:00:00-04:00","description":"This post has notes on how I added a macOS machine to my security homelab.","headline":"Adding macOS to my security homelab","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimobu.github.io/posts/macOS-Homelab/"},"url":"https://kimobu.github.io/posts/macOS-Homelab/"}</script><title>Adding macOS to my security homelab | kimobu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="kimobu"><meta name="application-name" content="kimobu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">kimobu</a></div><div class="site-subtitle font-italic">Docendo discimus</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/kimobu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kimo','kimobu.space'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://infosec.exchange/@kimobu" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Adding macOS to my security homelab</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Adding macOS to my security homelab</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Kimo B </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, May 10, 2023, 12:00 AM -0400" prep="on" > May 10, 2023 <i class="unloaded">2023-05-10T00:00:00-04:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1645 words">9 min</span></div></div><div class="post-content"><p>This post has notes on how I added a macOS machine to my security homelab.</p><h1 id="install-macos-to-proxmox">Install macOS to Proxmox</h1><p>Follow this <a href="https://www.nicksherlock.com/2022/10/installing-macos-13-ventura-on-proxmox/">guide</a> to install macOS onto a Proxmox cluster. This will result in an x86 based VM. I plan on looking into an ARM node in the future. Reference <a href="https://i12bretro.github.io/tutorials/0775.html">this page</a> if you don’t want to extract OSK yourself. Additional note, this installed to local-lvm, not my GlusterFS storage.</p><h1 id="bind-macos-to-active-directory">Bind macOS to Active Directory</h1><p>Since the rest of the lab is a Windows Active Directory domain, I wanted to join the macOS VM to the domain so domain users could login. Follow <a href="https://www.hexnode.com/blogs/macos-active-directory-binding-explained/">the guide here</a> for high level guidance. Ventura changed the look of the Directory Utility but the overall concepts are the same. In Directory Utility, tick the option to “create mobile account at login” and add the “Users” OU to allowed administration.</p><p>I had to make sure the DC is syncing time to NTP using:<br /> <code class="language-plaintext highlighter-rouge">w32tm /config /update /manualpeerlist:"0.pool.ntp.org,0x8 1.pool.ntp.org,0x8" /syncfromflags:MANUAL</code> then <code class="language-plaintext highlighter-rouge">w32tm /resync /rediscover</code></p><p>Once that was done, I made sure macOS is syncing time to the DC via:<br /> <code class="language-plaintext highlighter-rouge">sudo sntp -sS blue-dc01.blue.local</code></p><h1 id="security-tools">Security tools</h1><p>Finally I wanted to install some telemetry collecting tools. Security Onion uses OSQuery and Elastic.</p><h2 id="kolide-launcherosquery">Kolide launcher/osquery</h2><p>OSQuery is straight forward and deployment is documented in the <a href="https://docs.securityonion.net/en/2.3/osquery.html?highlight=macOS">Security Onion docs</a>.</p><h2 id="elastic">Elastic</h2><p>Elastic is a bit more complicated. Filebeats is the tool to ship logs from macOS to an Elastic stack. Follow installation instructions <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html">here</a> and just make sure the version of Filebeats matches the version provided by Security Onion. My Filebeat config:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="na">filebeat.inputs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">my-filestream-id</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
<span class="err">	</span><span class="pi">-</span> <span class="s">/var/log/*.log</span>
<span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">eslogger-filestream-id</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
<span class="err">	</span><span class="pi">-</span> <span class="s">/var/log/eslogger.json</span>
<span class="na">filebeat.config.modules</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">${path.config}/modules.d/*.yml</span>
  <span class="na">reload.enabled</span><span class="pi">:</span> <span class="kc">false</span>
<span class="na">setup.template.settings</span><span class="pi">:</span>
  <span class="na">index.number_of_shards</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">tags</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">macos"</span><span class="pi">]</span>
<span class="na">output.logstash</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">10.10.10.20:5044"</span><span class="pi">]</span>
<span class="na">processors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">add_host_metadata</span><span class="pi">:</span>
<span class="err">	</span>  <span class="na">when.not.contains.tags</span><span class="pi">:</span> <span class="s">forwarded</span>
  <span class="pi">-</span> <span class="na">add_cloud_metadata</span><span class="pi">:</span> <span class="s">~</span>
  <span class="pi">-</span> <span class="na">add_docker_metadata</span><span class="pi">:</span> <span class="s">~</span>
  <span class="pi">-</span> <span class="na">add_kubernetes_metadata</span><span class="pi">:</span> <span class="s">~</span>
</pre></table></code></div></div><h3 id="logs">Logs</h3><p>In the Filebeat config I’m sending all the .log files from /var/log/. Only system.log is likely to be useful, but it doesn’t really contain security data. The second filestream in the Filebeat config is for /var/log/eslogger.json. Apple’s <a href="https://developer.apple.com/documentation/endpointsecurity">Endpoint Security Framework</a> or ESF will generate data to hunt on. The ESF usage is, IMO, not ideal, so I created a script to run eslogger, <code class="language-plaintext highlighter-rouge">eslogger.sh</code> and dropped it in <code class="language-plaintext highlighter-rouge">/Library/Scripts</code>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
: <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">END</span><span class="sh">'
Events to capture:
		authentication / T1078 / valid account
		btm_launch_item_add / T1543 / persistence / sysmon 12
		btm_launch_item_remove / T1543
		create / TA0003, TA0009 / new file / sysmon 11
		deleteextattr / T1553.001 / remove quarantine
		exec / TA0002 / process creation / sysmon 1
		exit / TA0002 / process exit / sysmon 5
		kextload / T1547.001 / driver load / sysmon 6
		login_login / T1078 / valid account
		login_logout / T1078 / valid account
		mount / / mount filesystem
		openssh_login / T1078 / valid account
		openssh_logout / T1078 / valid account
		remote_thread_create / T1055 / inject process / sysmon 8
		uipc_connect / TA0010, TA0011 / networkconnect / sysmon 3
		unlink / T1070.004 / file delete / sysmon 23
		utimes / T1070.006 / timestomp / sysmon 2
		write / TA0003, TA0009 / file write / filter for persistence
		xp_malware_detected
		xp_malware_remediated
</span><span class="no">END

</span><span class="nv">pids</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-ef</span> | <span class="nb">grep </span>eslogger | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> <span class="nt">-v</span> bash | <span class="nb">grep</span> <span class="nt">-v</span> launchctl | <span class="nb">awk</span> <span class="s1">'{ print $2 }'</span><span class="si">)</span><span class="p">;</span> <span class="k">for </span>pid <span class="k">in</span> <span class="nv">$pids</span><span class="p">;</span> <span class="k">do </span><span class="nb">kill</span> <span class="nt">-9</span> <span class="nv">$pid</span><span class="p">;</span> <span class="k">done</span>

/usr/bin/eslogger authentication btm_launch_item_add btm_launch_item_remove create deleteextattr <span class="nb">exec exit </span>kextload login_login login_logout mount openssh_login openssh_logout remote_thread_create uipc_connect <span class="nb">unlink </span>utimes xp_malware_detected xp_malware_remediated <span class="o">&gt;&gt;</span> /var/log/eslogger.json
</pre></table></code></div></div><p>Now that script needs to be started. It’s just appending all eslogger output to a single JSON file, and it can generate quite a bit of data. To keep my VM’s disk from filling up, I wanted to rotate the log. Since I’m using a bash script to start eslogger I needed to sequence rotating the logs and restarting eslogger to have it pick up that the log file was rotated and write to the correct one. This is a hacky approach that shouldn’t be used in production since there could be a one minute gap in logs.</p><p>First, create a launch daemon <code class="language-plaintext highlighter-rouge">eslogger.plist</code> that starts the script on a schedule. This daemon will run every day at 12:01AM.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
	<span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>com.eslogger<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;array&gt;</span>
		<span class="nt">&lt;string&gt;</span>/bin/bash<span class="nt">&lt;/string&gt;</span>
		<span class="nt">&lt;string&gt;</span>/Library/Scripts/eslogger.sh<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;/array&gt;</span>
	<span class="nt">&lt;key&gt;</span>StartCalendarInterval<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;dict&gt;</span>
		<span class="nt">&lt;key&gt;</span>Hour<span class="nt">&lt;/key&gt;</span>
		<span class="nt">&lt;integer&gt;</span>0<span class="nt">&lt;/integer&gt;</span>
		<span class="nt">&lt;key&gt;</span>Minute<span class="nt">&lt;/key&gt;</span>
		<span class="nt">&lt;integer&gt;</span>1<span class="nt">&lt;/integer&gt;</span>
	<span class="nt">&lt;/dict&gt;</span>
	<span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;true/&gt;</span>
	<span class="nt">&lt;key&gt;</span>UserName<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>root<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>StandardOutPath<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>/tmp/com.eslogger.stdout<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>StandardErrorPath<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>/tmp/com.eslogger.stderr<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</pre></table></code></div></div><p>Next, edit the newsyslog config to rotate logs every day at midnight <code class="language-plaintext highlighter-rouge">/etc/newsyslog.d/eslogger.conf</code>. Log rotates at 12:00 and eslogger restarts at 12:01.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre># logfilename           [owner:group]      mode count size(KB)  when  flags [/pid_file]          [sig_num]
/var/log/eslogger.json  :                  600  2     16384      $D0     J    
</pre></table></code></div></div><h2 id="ingest-pipelines">Ingest pipelines</h2><p>Last is to parse the eslogger output into Elastic Common Schema (ECS). I started off trying to use a Logstash pipeline but ended up with an Elasticsearch ingest pipeline. These go into <code class="language-plaintext highlighter-rouge">/opt/so/saltstack/local/salt/elasticsearch/files/ingest</code>.</p><p>First I copied SO’s beats.common and added a pipeline for eslogger:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w"> </span><span class="nl">"pipeline"</span><span class="p">:</span><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.tags?.contains('macos')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslogger"</span><span class="w">  </span><span class="p">}</span><span class="w">  </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></pre></table></code></div></div><p>Then I created the eslogger pipeline. This was my first time writing an ingest pipeline. I originally tried to just write the pipeline in vim, but found that using the interface in Kibana was more helpful in getting immediate feedback on what data a document provided and how it was changed by the pipeline actions. The resulting pipeline follows. The overall flow is to copy the “message” field to “message2”, then examine the keys to determine what type of ESF event was sent and categorize it. Then for each type of event, set ECS fields.</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Parse Apple's eslogger output"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"processors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"json"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w"> </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2"</span><span class="p">,</span><span class="w">  </span><span class="nl">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslogger-json"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.code"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.module"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslogger"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"observer.name"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('create')"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,process"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('exec')"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,launch_item"</span><span class="p">,</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('btm_launch_item_add')"</span><span class="w">  </span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('deleteextattr')"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,process"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('exit')"</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,account"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('authentication')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,driver"</span><span class="p">,</span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('kextload')"</span><span class="w">  </span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,account"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('login_login')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,account"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('login_logout')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,filesystem"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('mount')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,account"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('openssh_login')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,account"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('openssh_logout')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,process"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('remote_thread_create')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('unlink')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('utimes')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('write')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('xp_malware_detected')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.category"</span><span class="p">,</span><span class="w">  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host,file"</span><span class="p">,</span><span class="w">  </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('xp_malware_remediated')"</span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('create')"</span><span class="p">,</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file_create"</span><span class="p">,</span><span class="w">         </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('exec')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process_creation"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('btm_launch_item_add')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"btm_launch_item_add"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('deleteextattr')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process_changed_file"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('exit')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process_terminated"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('authentication')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"authentication"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('kextload')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"driver_loaded"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('login_login')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_login"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('login_logout')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_logout"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('mount')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"filesystem_mounted"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('openssh_login')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_login"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('openssh_logout')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_logout"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('remote_thread_create')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create_remote_thread"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('unlink')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file_delete"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('utimes')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process_changed_file"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('write')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process_changed_file"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('xp_malware_detected')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"malware_detected"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="w"> </span><span class="nl">"set"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"if"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ctx.message2.event.containsKey('xp_malware_remediated')"</span><span class="p">,</span><span class="w">   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event.dataset"</span><span class="p">,</span><span class="w">   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"malware_remediated"</span><span class="p">,</span><span class="w">        </span><span class="nl">"override"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.exec.args"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.command_line"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.exec.target.executable.path"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.executable"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.process.audit_token.pid"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.pid"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.process.executable.path"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.executable"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.exec.target.signing_id"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.macho.company"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.process.parent_audit_token.pid"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.ppid"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.exec.cwd.path"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"process.working_directory"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.process.audit_token.euid"</span><span class="p">,</span><span class="w">  </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user.id"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.create.destination.existing_file.path"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file.target"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.btm_launch_item_add.item"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maclog.event_data.launch_item"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.btm_launch_item_add.executable_path"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maclog.event_data.launch_item.executable"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.btm_launch_item_remove.item"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maclog.event_data.launch_item"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.btm_launch_item_remove.executable_path"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maclog.event_data.launch_item.executable"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2.event.unlink.target.path"</span><span class="p">,</span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file.target"</span><span class="p">,</span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="nl">"ignore_failure"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="p">}},</span><span class="w">
	   </span><span class="p">{</span><span class="nl">"remove"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message2"</span><span class="p">,</span><span class="w">  </span><span class="nl">"ignore_missing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span><span class="w">  </span><span class="p">}]</span><span class="w">
</span></pre></table></code></div></div><p>With all that set up, I can see the parsed events in Kibana and start hunting!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/eslogger-elastic.png" alt="eslogger output in Kibana" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/tags/macos/" class="post-tag no-text-decoration" >macos</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Adding macOS to my security homelab - kimobu&url=https://kimobu.github.io/posts/macOS-Homelab/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Adding macOS to my security homelab - kimobu&u=https://kimobu.github.io/posts/macOS-Homelab/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Adding macOS to my security homelab - kimobu&url=https://kimobu.github.io/posts/macOS-Homelab/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SecurityOnion-GPT/">SecurityOnion GPT</a><li><a href="/posts/Adding-Phishing-to-the-Homelab/">Putting phishing data into Security Onion</a><li><a href="/posts/Books-of-2022/">Recap of the books I read in 2022</a><li><a href="/posts/Books-of-2021/">Recap of the books I read in 2021</a><li><a href="/posts/Books-of-2017/">Recap of the books I read in 2017</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Security-Onion-Proxmox/"><div class="card-body"> <span class="timeago small" > May 26, 2021 <i class="unloaded">2021-05-26T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Security Onion on Proxmox</h3><div class="text-muted small"><p> Security Onion on Proxmox I originally set up my homelab using Ovirt, but have since switched back to Proxmox. The reason for that is that the version of qemu that Ovirt ships with does not support...</p></div></div></a></div><div class="card"> <a href="/posts/log4j-JDNI-Exploitation/"><div class="card-body"> <span class="timeago small" > Dec 10, 2021 <i class="unloaded">2021-12-10T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>log4j JNDI Exploitation</h3><div class="text-muted small"><p> Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URL...</p></div></div></a></div><div class="card"> <a href="/posts/Adding-Phishing-to-the-Homelab/"><div class="card-body"> <span class="timeago small" > Jul 20, 2023 <i class="unloaded">2023-07-20T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Putting phishing data into Security Onion</h3><div class="text-muted small"><p> I wanted to add some phishing scenarios to my hunting homelab. I’m more concerned with being able to hunt on malicious emails than on stopping them, so DMARC, DKIM, and SPF are out of scope. If you...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Books-of-2022/" class="btn btn-outline-primary" prompt="Older"><p>Recap of the books I read in 2022</p></a> <a href="/posts/Adding-Phishing-to-the-Homelab/" class="btn btn-outline-primary" prompt="Newer"><p>Putting phishing data into Security Onion</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/kimobu">Kimo B</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimobu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
