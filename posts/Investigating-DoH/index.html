<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Investigating DoH" /><meta property="og:locale" content="en_US" /><meta name="description" content="DNS Security As a plain-text protocol, DNS lacks Confidentiality, Integrity, and Availability (CIA) protections. An attacker who can observe DNS activity can see where the DNS request originated from, where responses came from, what the query and response were, or tamper with the response." /><meta property="og:description" content="DNS Security As a plain-text protocol, DNS lacks Confidentiality, Integrity, and Availability (CIA) protections. An attacker who can observe DNS activity can see where the DNS request originated from, where responses came from, what the query and response were, or tamper with the response." /><link rel="canonical" href="https://kimobu.github.io/posts/Investigating-DoH/" /><meta property="og:url" content="https://kimobu.github.io/posts/Investigating-DoH/" /><meta property="og:site_name" content="kimobu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-12-31T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Investigating DoH" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-07T09:30:23-04:00","datePublished":"2019-12-31T00:00:00-05:00","description":"DNS Security As a plain-text protocol, DNS lacks Confidentiality, Integrity, and Availability (CIA) protections. An attacker who can observe DNS activity can see where the DNS request originated from, where responses came from, what the query and response were, or tamper with the response.","headline":"Investigating DoH","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimobu.github.io/posts/Investigating-DoH/"},"url":"https://kimobu.github.io/posts/Investigating-DoH/"}</script><title>Investigating DoH | kimobu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="kimobu"><meta name="application-name" content="kimobu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">kimobu</a></div><div class="site-subtitle font-italic">Docendo discimus</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/kimobu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kimo','kimobu.space'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://infosec.exchange/@kimobu" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Investigating DoH</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Investigating DoH</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Kimo B </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 31, 2019, 12:00 AM -0500" prep="on" > Dec 31, 2019 <i class="unloaded">2019-12-31T00:00:00-05:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 7, 2021, 9:30 AM -0400" prefix="Updated " > Jun 7, 2021 <i class="unloaded">2021-06-07T09:30:23-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="893 words">4 min</span></div></div><div class="post-content"><h1 id="dns-security">DNS Security</h1><p>As a plain-text protocol, DNS lacks Confidentiality, Integrity, and Availability (CIA) protections. An attacker who can observe DNS activity can see where the DNS request originated from, where responses came from, what the query and response were, or tamper with the response.</p><p>DNS over HTTPS (DoH) effectively mitigates many of those weaknesses. Instead of being a plain-text protocol over UDP, DoH is an exchange of DNS queries and responses over a TLS encrypted connection, using the HTTP2 protocol to transmit messages. Because of this encryption, an attacker can neither observe nor tamper with DoH queries and responses.</p><p>DNS is used by malware to perform lookups on Command and Control (C2) servers. Malware can also use DNS as a covert-channel, embedding commands or exfiltrated data as encoded values within a DNS datagram. Security software (i.e. Intrusion Detection Systems [IDS]) observes network traffic to identify known C2 domains being resolved (signature matching). An IDS can also use anomaly detection to identify potential malicious use of DNS through various features of the DNS query or response.</p><h1 id="detecting-malicious-dns">Detecting Malicious DNS</h1><p>In the following table, some of the features which are used in IDS detecction algorithms are presented.</p><div class="table-wrapper"><table><thead><tr><th>Feature<th>Description<th>Visible in DoH<tbody><tr><td>Domain name<td>The name that was queried<td>No<tr><td>IP address<td>Either the source or destination IP address of the DNS query<td>Yes<tr><td>Port<td>Either the source or destination port of the DNS query<td>Yes<tr><td>Timestamp<td>When the DNS query or response took place<td>Maybe - Need to be able to differentiate between DoH and other HTTPS traffic<tr><td>Record type<td>The type of DNS record queried - A, AAAA, MX, etc<td>No<tr><td>NXDOMAIN<td>A DNS response of “no domain record” - useful in identifying malware using a Domain Generating Algorithm (DGA)<td>No<tr><td>Web presence<td>An active lookup performed by the IDS, checking for whether there is a “legitimate” web presence of the queried domain<td>No, requires knowledge of the resolved domain name<tr><td>Entropy<td>The entropy of the queried domain - useful in identifying DNS being used as a covert channel<td>No<tr><td>Unique query ratio<td>The number of unique queries from a given DNS client<td>No<tr><td>Query volume<td>The total number of DNS queries from a given client<td>No<tr><td>Longest meaningful word<td>The longest “real” word that is part of the resolved domain. “Real” domains/services should use real words somewhere in the domain or subdomain<td>No<tr><td>Unique subdomains<td>The number of unique subdomains - used in covert channel detection.<td>No<tr><td>Number of subdomains<td>The total number of subdomains queried in a given domain<td>No</table></div><p>As we can see from that table, most of the features of a DNS query/response which are used to detect malware using DNS are not available due to the TLS encryption. Further, if the HTTP GET method is used, the format of the query is different than what is used in normal DNS, so additional processing of packets must occur to obtain the features in a format that can be processed by exiting systems.</p><h1 id="generating-doh-test-data">Generating DoH Test Data</h1><p>To generate DoH test data, I used a CentOS 8 VM with 4x 3.2Ghz CPU and 8GB RAM.</p><p>Facebook provides a <a href="https://facebookexperimental.github.io/doh-proxy/">DoH Proxy Server and a client</a> which were used to generate the traffic. The software is available as a PIP package.</p><p><code class="language-plaintext highlighter-rouge">pip3 install doh-proxy sslkeylog</code> A TLS certificate and key are needed. <code class="language-plaintext highlighter-rouge">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout selfsigned.key -out selfsigned.pem</code> Now the DoH proxy can be ran. <code class="language-plaintext highlighter-rouge">doh-proxy --upstream your_upstream_dns --certfile=./selfsigned.pem --keyfile=./selfsigned.key --listen-address=0.0.0.0</code></p><p>At this point, you should be able to point a client which can use DoH to the DoH Proxy and resolve domain names. I had trouble getting Firefox on a Windows 10 VM to consistently use the DoH Proxy, so I ended up using the <code class="language-plaintext highlighter-rouge">doh-client</code> instead. This had the added benefit of easily scripting queries. I used the first 100,000 records of the <a href="https://majestic.com/reports/majestic-million">Majestic Million</a> dataset. The full script used to generate queries is availble <a href="https://raw.githubusercontent.com/kimobu/doh-investigation/master/gen_doh.py">on Github</a>.</p><p>One last thing I needed to do was modify the <code class="language-plaintext highlighter-rouge">utils.py</code> file of the DoH Proxy and add the following lines. The SSLKeyLog package will save TLS keys exchanged during TLS session setup. This is a requirement in order to decrypt TLS 1.3, which uses Forward Secrecy.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>import sslkeylog
sslkeylog.set_keylog("/root/sslkeylog.txt")
</pre></table></code></div></div><p>While executing the <code class="language-plaintext highlighter-rouge">gen_doh.py</code> script, I used <code class="language-plaintext highlighter-rouge">tcpdump</code> to capture the traffic. <code class="language-plaintext highlighter-rouge">tcpdump -i lo -s 65535 -w doh_get.pcap</code> Once the script has finished, the PCAP can be opened with Wireshark and confirm that all of the traffic is TLS encrypted. Using <code class="language-plaintext highlighter-rouge">tshark</code> and the SSLKeyLog file, we can decrypt the traffic to see what DoH looks like on the wire. <code class="language-plaintext highlighter-rouge">time tshark -r doh_get.pcap -V -x -o "ssl.desegment_ssl_records: TRUE" -o "ssl.desegment_ssl_application_data: TRUE" -o "ssl.keys_list:127.0.0.1,443,http,selfsigned.pem" -o "ssl.keylog_file:sslkeylog.txt" -w doh_get_decrypted.pcap</code> This process was performed once for GET traffic and once for POST. The average time to decrypt those two PCAPs was 876.5 seconds.</p><div class="table-wrapper"><table><thead><tr><th>HTTP Action<th>Packets<th>File size<th>Decrypted file size<tbody><tr><td>GET<td>2,078,688<td>504,824,100<td>542,107,992<tr><td>POST<td>2,177,897<td>516,151,600<td>555,337,372</table></div><p>The encrypted DoH traffic provides only Netflow information. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/content/images/2019/12/doh_get.png" alt="doh_get" /></p><p>Once unencrypted, we can see the queried domain and response. When using GET, the domain query is base64 encoded, contributing to additional processing needed to transform the data into a usable format. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/content/images/2019/12/doh_post.png" alt="doh_post" /></p><h1 id="future-work">Future work</h1><ul><li>Analysis of TLS decryption on larger datasets, discriminating between DoH and non-DoH traffic<li>Transformation of DoH traffic to DNS wire format for feeding into IDS</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/research/'>research</a>, <a href='/categories/networking/'>networking</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/networking/" class="post-tag no-text-decoration" >networking</a> <a href="/tags/research/" class="post-tag no-text-decoration" >research</a> <a href="/tags/school/" class="post-tag no-text-decoration" >school</a> <a href="/tags/doh/" class="post-tag no-text-decoration" >doh</a> <a href="/tags/dns/" class="post-tag no-text-decoration" >dns</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Investigating DoH - kimobu&url=https://kimobu.github.io/posts/Investigating-DoH/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Investigating DoH - kimobu&u=https://kimobu.github.io/posts/Investigating-DoH/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Investigating DoH - kimobu&url=https://kimobu.github.io/posts/Investigating-DoH/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SecurityOnion-GPT/">SecurityOnion GPT</a><li><a href="/posts/Adding-Phishing-to-the-Homelab/">Putting phishing data into Security Onion</a><li><a href="/posts/Books-of-2022/">Recap of the books I read in 2022</a><li><a href="/posts/Books-of-2021/">Recap of the books I read in 2021</a><li><a href="/posts/Books-of-2017/">Recap of the books I read in 2017</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Converting-DoH-to-DNS/"><div class="card-body"> <span class="timeago small" > Jan 6, 2021 <i class="unloaded">2021-01-06T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Converting DoH to DNS</h3><div class="text-muted small"><p> In a previous post I wrote about investigations that I performed on DNS over HTTPS (DoH). That research was performed as part of Cyber Security Research. During Security Tool Development, I expande...</p></div></div></a></div><div class="card"> <a href="/posts/log4j-JDNI-Exploitation/"><div class="card-body"> <span class="timeago small" > Dec 10, 2021 <i class="unloaded">2021-12-10T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>log4j JNDI Exploitation</h3><div class="text-muted small"><p> Situation A remote code execution (RCE) bug was found in log4j. CVE 2021-44228 has been assigned to it. The vulnerability lies in how log4j interprets Java Naming and Directory Interface (JNDI) URL...</p></div></div></a></div><div class="card"> <a href="/posts/Reflecting-on-a-PhD/"><div class="card-body"> <span class="timeago small" > May 13, 2022 <i class="unloaded">2022-05-13T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reflecting on Completing a PhD</h3><div class="text-muted small"><p> In March of this year, I successfully defended my dissertation An Application of Machine Learning to Packed Mach-O Detection. After four years, I completed a PhD in Cyber Operations from Dakota Sta...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Books-of-2019/" class="btn btn-outline-primary" prompt="Older"><p>Recap of the books I read in 2019</p></a> <a href="/posts/Installing-the-Cuckoo-sandbox-using-KVM/" class="btn btn-outline-primary" prompt="Newer"><p>Installing the Cuckoo Sandbox Using KVM</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/kimobu">Kimo B</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/school/">school</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/doh/">doh</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/offsec/">offsec</a> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/kali/">kali</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimobu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
